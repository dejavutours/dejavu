<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../../partials/headtag', {isNiceSelect: false}); %>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Booking Lead Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f3f4f6; }
    .detail-card { background: white; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.25rem; font-weight: 600; color: #1e3a8a; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
    .quick-actions-bar { background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .sticky-action-bar { position: sticky; bottom: 0; background: white; border-top: 2px solid #e5e7eb; padding: 1rem; margin-top: 2rem; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); z-index: 100; display: none; }
    @media (max-width: 768px) {
      .sticky-action-bar { display: flex; gap: 0.5rem; justify-content: center; }
      .quick-actions-bar { position: sticky; top: 0; z-index: 99; }
    }
  </style>
</head>
<body>
  <%- include('../../partials/header', {isSearch: false}); %>
  <div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/bookings">Bookings</a></li>
        <li class="breadcrumb-item"><a href="/admin/booking-leads">Booking Leads</a></li>
        <li class="breadcrumb-item active" aria-current="page">Lead Details</li>
      </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Booking Lead Details</h1>
      <div>
        <a href="/admin/booking-leads" class="btn btn-secondary"><i class="bi bi-arrow-left me-2"></i>Back to Leads</a>
      </div>
    </div>

    <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
    <% } else if (lead) { %>

    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">

      <button class="btn btn-primary" onclick="updateStatus()">
        <i class="bi bi-arrow-repeat me-2"></i>Update Status
      </button>
      <% if (lead.leadStatus !== 'converted') { %>
      <button class="btn btn-danger" onclick="deleteLead()">
        <i class="bi bi-trash me-2"></i>Delete Lead
      </button>
      <% } %>
    </div>

    <!-- Lead Info -->
    <div class="detail-card">
      <h3 class="section-title">Lead Information</h3>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Lead ID:</strong> <%= lead._id %></p>
          <p><strong>Status:</strong> 
            <span class="badge <%= lead.leadStatus === 'pending' ? 'badge-pending' : 
                                  lead.leadStatus === 'contacted' ? 'badge-contacted' : 
                                  lead.leadStatus === 'converted' ? 'badge-converted' : 'badge-rejected' %>">
              <%= lead.leadStatus.charAt(0).toUpperCase() + lead.leadStatus.slice(1) %>
            </span>
          </p>
          <p><strong>Trip:</strong> <%= lead.tourDetails?.name || 'N/A' %></p>
          <p><strong>Created:</strong> <%= new Date(lead.createdAt).toLocaleString('en-GB') %></p>
        </div>
        <div class="col-md-6">
          <p><strong>Guest Name:</strong> <%= lead.guestName || lead.userDetails?.details?.firstName || 'N/A' %></p>
          <p><strong>Phone:</strong> <%= lead.guestPhone || lead.userDetails?.phoneNumber || lead.userDetails?.details?.mobileNumber || 'N/A' %></p>
          <p><strong>Email:</strong> <%= lead.guestEmail || lead.userDetails?.email || lead.userDetails?.details?.email || 'N/A' %></p>
          <p><strong>Callback Requested:</strong> <%= lead.callbackRequested ? 'Yes' : 'No' %></p>
        </div>
      </div>
    </div>

    <!-- Booking Details -->
    <div class="detail-card">
      <h3 class="section-title">Booking Details</h3>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Transport Type:</strong> <%= lead.transportType %></p>
          <p><strong>Joining From:</strong> <%= lead.joiningFrom %></p>
          <p><strong>Trip Start Date:</strong> <%= new Date(lead.tripStartDate).toLocaleDateString('en-GB') %></p>
          <p><strong>Trip End Date:</strong> <%= new Date(lead.tripEndDate).toLocaleDateString('en-GB') %></p>
        </div>
        <div class="col-md-6">
          <p><strong>Adults:</strong> <%= lead.totalPerson?.adult || 0 %></p>
          <p><strong>Children:</strong> <%= lead.totalPerson?.child || 0 %></p>
          <p><strong>Total Cost (with GST):</strong> ₹<%= lead.totalTripCostWithGST?.toFixed(2) || '0.00' %></p>
        </div>
      </div>
    </div>

    <!-- Person Details -->
    <div class="detail-card">
      <h3 class="section-title">Person Details</h3>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Name</th>
              <th>Gender</th>
              <th>Birthdate</th>
              <th>Phone</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            <% if (lead.personDetails && lead.personDetails.length > 0) { %>
              <% lead.personDetails.forEach(person => { %>
              <tr>
                <td><%= person.firstName %> <%= person.surname %></td>
                <td><%= person.gender %></td>
                <td><%= new Date(person.birthdate).toLocaleDateString('en-GB') %></td>
                <td><%= person.phone %></td>
                <td><%= person.isAdult ? 'Adult' : 'Child' %></td>
              </tr>
              <% }); %>
            <% } else { %>
              <tr><td colspan="5">No person details available</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Admin Actions -->
    <div class="detail-card">
      <h3 class="section-title">Admin Actions</h3>
      
      <!-- Status Update -->
      <div class="mb-3">
        <label class="form-label">Update Status</label>
        <div class="input-group">
          <select class="form-select" id="leadStatus">
            <option value="pending" <%= lead.leadStatus === 'pending' ? 'selected' : '' %>>Pending</option>
            <option value="contacted" <%= lead.leadStatus === 'contacted' ? 'selected' : '' %>>Contacted</option>
            <option value="converted" <%= lead.leadStatus === 'converted' ? 'selected' : '' %>>Converted</option>
            <option value="rejected" <%= lead.leadStatus === 'rejected' ? 'selected' : '' %>>Rejected</option>
          </select>
          <button class="btn btn-primary" onclick="updateStatus()">Update Status</button>
        </div>
      </div>

      <!-- Admin Notes -->
      <div class="mb-3">
        <label class="form-label">Admin Notes</label>
        <textarea class="form-control" id="adminNotes" rows="3"><%= lead.adminNotes || '' %></textarea>
        <button class="btn btn-secondary mt-2" onclick="updateNotes()">Save Notes</button>
      </div>

      <!-- Convert to Booking -->
      <% if (lead.leadStatus !== 'converted') { %>
      <div class="mb-3">
        <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#convertModal">
          <i class="bi bi-check-circle me-2"></i>Convert to Booking
        </button>
      </div>
      <% } else if (lead.convertedBooking) { %>
      <div class="alert alert-success">
        <strong>Converted to Booking:</strong> 
        <a href="/admin/bookings/<%= lead.convertedToBookingId %>">View Booking <%= lead.convertedBooking.bookingNumber %></a>
      </div>
      <% } %>

    </div>

    <!-- Sticky Action Bar (Mobile) -->
    <div class="sticky-action-bar">
      <% if (lead.leadStatus !== 'converted') { %>
      <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#convertModal">
        <i class="bi bi-check-circle me-1"></i>Convert
      </button>
      <% } %>
      <button class="btn btn-primary btn-sm" onclick="updateStatus()">
        <i class="bi bi-arrow-repeat me-1"></i>Update
      </button>
      <% if (lead.leadStatus !== 'converted') { %>
      <button class="btn btn-danger btn-sm" onclick="deleteLead()">
        <i class="bi bi-trash me-1"></i>Delete
      </button>
      <% } %>
    </div>

    <!-- Convert Modal -->
    <div class="modal fade" id="convertModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Convert Lead to Booking</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Final Amount *</label>
              <input type="number" class="form-control" id="convertFinalAmount" value="<%= lead.totalTripCostWithGST %>" step="0.01" onchange="calculateConvertDiscount()">
            </div>
            <div class="mb-3">
              <label class="form-label">Discount Amount</label>
              <input type="text" class="form-control" id="convertDiscount" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label">Payment Status</label>
              <select class="form-select" id="convertPaymentStatus">
                <option value="Pending">Pending</option>
                <option value="Partial">Partial</option>
                <option value="Paid">Paid</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Booking Status</label>
              <select class="form-select" id="convertBookingStatus">
                <option value="Pending">Pending</option>
                <option value="Confirmed">Confirmed</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" id="convertNotes" rows="2"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" onclick="convertToBooking()">Convert</button>
          </div>
        </div>
      </div>
    </div>

    <% } %>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastMessage"></div>
    </div>
  </div>

  <script>
    // Toast notification function
    function showToast(title, message, type = 'success') {
      const toastEl = document.getElementById('toastNotification');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      
      // Set toast type styling
      toastEl.className = 'toast';
      if (type === 'error') {
        toastEl.classList.add('text-bg-danger');
      } else if (type === 'warning') {
        toastEl.classList.add('text-bg-warning');
      } else {
        toastEl.classList.add('text-bg-success');
      }
      
      const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });
      toast.show();
    }
    function calculateConvertDiscount() {
      const original = <%= lead.totalTripCostWithGST || 0 %>;
      const final = parseFloat(document.getElementById('convertFinalAmount').value) || 0;
      const discount = Math.max(0, original - final);
      document.getElementById('convertDiscount').value = '₹' + discount.toFixed(2);
    }

    async function updateStatus() {
      const status = document.getElementById('leadStatus').value;
      const notes = document.getElementById('adminNotes').value;
      
      try {
        const response = await fetch(`/admin/booking-leads/<%= lead._id %>/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '<%= csrfToken %>',
          },
          body: JSON.stringify({ leadStatus: status, adminNotes: notes }),
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('Success', 'Status updated successfully', 'success');
          setTimeout(() => window.location.reload(), 1500);
        } else {
          showToast('Error', result.message || 'Failed to update status', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred', 'error');
      }
    }

    async function updateNotes() {
      const notes = document.getElementById('adminNotes').value;
      
      try {
        const response = await fetch(`/admin/booking-leads/<%= lead._id %>/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '<%= csrfToken %>',
          },
          body: JSON.stringify({ adminNotes: notes }),
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('Success', 'Notes saved successfully', 'success');
        } else {
          showToast('Error', result.message || 'Failed to save notes', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred', 'error');
      }
    }

    async function convertToBooking() {
      const finalAmount = parseFloat(document.getElementById('convertFinalAmount').value);
      const paymentStatus = document.getElementById('convertPaymentStatus').value;
      const bookingStatus = document.getElementById('convertBookingStatus').value;
      const notes = document.getElementById('convertNotes').value;
      
      if (!finalAmount || finalAmount <= 0) {
        showToast('Validation Error', 'Please enter a valid final amount', 'warning');
        return;
      }
      
      try {
        const response = await fetch(`/admin/booking-leads/<%= lead._id %>/convert`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '<%= csrfToken %>',
          },
          body: JSON.stringify({
            adminFinalAmount: finalAmount,
            paymentStatus,
            bookingStatus,
            adminNotes: notes,
          }),
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('Success', 'Lead converted to booking successfully! Booking Number: ' + result.bookingNumber, 'success');
          setTimeout(() => window.location.href = `/admin/bookings/${result.bookingId}`, 1500);
        } else {
          showToast('Error', result.message || 'Failed to convert lead', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred', 'error');
      }
    }

    async function deleteLead() {
      if (!confirm('Are you sure you want to delete this lead?')) return;
      
      try {
        const response = await fetch(`/admin/booking-leads/<%= lead._id %>`, {
          method: 'DELETE',
          headers: {
            'X-CSRF-Token': '<%= csrfToken %>',
          },
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('Success', 'Lead deleted successfully', 'success');
          setTimeout(() => window.location.href = '/admin/booking-leads', 1500);
        } else {
          showToast('Error', result.message || 'Failed to delete lead', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred', 'error');
      }
    }

    // Calculate discount on page load
    calculateConvertDiscount();
  </script>
  
  <!-- Bootstrap JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
</body>
</html>

