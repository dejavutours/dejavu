<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('../../partials/headtag', {isNiceSelect: false}); %>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Booking Leads</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body { background-color: #f3f4f6; }
    .stats-card { background: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .badge-pending { background-color: #fbbf24; color: #000; }
    .badge-contacted { background-color: #3b82f6; color: #fff; }
    .badge-converted { background-color: #10b981; color: #fff; }
    .badge-rejected { background-color: #ef4444; color: #fff; }
  </style>
</head>
<body>
  <%- include('../../partials/header', {isSearch: false}); %>
  <div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-3">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/bookings">Bookings</a></li>
        <li class="breadcrumb-item active" aria-current="page">Booking Leads</li>
      </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <h1>Booking Leads</h1>
      <div class="d-flex gap-2">
        <a href="/admin/bookings/create" class="btn btn-success"><i class="bi bi-plus-circle me-2"></i>Create Booking</a>
        <a href="/admin/bookings" class="btn btn-secondary"><i class="bi bi-arrow-left me-2"></i>Back to Bookings</a>
      </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stats-card">
          <h6 class="text-muted">Total Leads</h6>
          <h3><%= stats.totalLeads %></h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h6 class="text-muted">Pending</h6>
          <h3 class="text-warning"><%= stats.pendingLeads %></h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h6 class="text-muted">Contacted</h6>
          <h3 class="text-info"><%= stats.contactedLeads %></h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <h6 class="text-muted">Converted</h6>
          <h3 class="text-success"><%= stats.convertedLeads %></h3>
        </div>
      </div>
    </div>

    <!-- Quick Filter Chips -->
    <div class="mb-3 d-flex gap-2 flex-wrap">
      <a href="/admin/booking-leads" class="btn btn-sm <%= !filters.leadStatus ? 'btn-primary' : 'btn-outline-primary' %>">All</a>
      <a href="/admin/booking-leads?leadStatus=pending" class="btn btn-sm <%= filters.leadStatus === 'pending' ? 'btn-warning' : 'btn-outline-warning' %>">Pending</a>
      <a href="/admin/booking-leads?leadStatus=contacted" class="btn btn-sm <%= filters.leadStatus === 'contacted' ? 'btn-info' : 'btn-outline-info' %>">Contacted</a>
      <a href="/admin/booking-leads?leadStatus=converted" class="btn btn-sm <%= filters.leadStatus === 'converted' ? 'btn-success' : 'btn-outline-success' %>">Converted</a>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <form method="GET" action="/admin/booking-leads" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" name="leadStatus">
              <option value="">All</option>
              <option value="pending" <%= filters.leadStatus === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="contacted" <%= filters.leadStatus === 'contacted' ? 'selected' : '' %>>Contacted</option>
              <option value="converted" <%= filters.leadStatus === 'converted' ? 'selected' : '' %>>Converted</option>
              <option value="rejected" <%= filters.leadStatus === 'rejected' ? 'selected' : '' %>>Rejected</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Trip Start Date</label>
            <input type="date" class="form-control" name="tripStartDate" value="<%= filters.tripStartDate || '' %>">
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary mt-4">Filter</button>
            <a href="/admin/booking-leads" class="btn btn-secondary mt-4">Clear</a>
          </div>
        </form>
      </div>
    </div>

    <!-- Leads Table -->
    <div class="card">
      <div class="card-body">
        <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
        <% } %>
        
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Lead ID</th>
                <th>Trip Name</th>
                <th>Guest Name</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Trip Date</th>
                <th>Total Cost</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (leads && leads.length > 0) { %>
                <% leads.forEach(lead => { %>
                <tr>
                  <td><%= lead._id.toString().substring(0, 8) %>...</td>
                  <td><%= lead.tourDetails?.name || 'N/A' %></td>
                  <td><%= lead.guestName || lead.userDetails?.details?.firstName || 'N/A' %></td>
                  <td><%= lead.guestPhone || lead.userDetails?.phoneNumber || lead.userDetails?.details?.mobileNumber || 'N/A' %></td>
                  <td><%= lead.guestEmail || lead.userDetails?.email || lead.userDetails?.details?.email || 'N/A' %></td>
                  <td><%= new Date(lead.tripStartDate).toLocaleDateString('en-GB') %></td>
                  <td>â‚¹<%= lead.totalTripCostWithGST?.toFixed(2) || '0.00' %></td>
                  <td>
                    <span class="badge badge-<%= lead.leadStatus %>">
                      <%= lead.leadStatus.charAt(0).toUpperCase() + lead.leadStatus.slice(1) %>
                    </span>
                  </td>
                  <td><%= new Date(lead.createdAt).toLocaleDateString('en-GB') %></td>
                  <td>
                    <a href="/admin/booking-leads/<%= lead._id %>" class="btn btn-sm btn-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </a>
                    <% if (lead.leadStatus === 'pending' || lead.leadStatus === 'contacted') { %>
                    <a href="/admin/booking-leads/<%= lead._id %>" class="btn btn-sm btn-success" title="Convert to Booking">
                      <i class="bi bi-check-circle"></i>
                    </a>
                    <% } %>
                    <% if (lead.leadStatus !== 'converted') { %>
                    <button class="btn btn-sm btn-danger" onclick="deleteLead('<%= lead._id %>')" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                    <% } %>
                  </td>
                </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="10" class="text-center">No booking leads found</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if (totalLeads > 10) { %>
        <div class="d-flex justify-content-center mt-4">
          <% for(let i = 1; i <= Math.ceil(totalLeads / 10); i++) { %>
          <a href="/admin/booking-leads?page=<%= i %>" class="btn btn-sm <%= currentPage === i ? 'btn-primary' : 'btn-outline-primary' %> me-1"><%= i %></a>
          <% } %>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
    <div id="toastNotification" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto" id="toastTitle">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="toastMessage"></div>
    </div>
  </div>

  <script>
    // Toast notification function
    function showToast(title, message, type = 'success') {
      const toastEl = document.getElementById('toastNotification');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      
      toastEl.className = 'toast';
      if (type === 'error') {
        toastEl.classList.add('text-bg-danger');
      } else if (type === 'warning') {
        toastEl.classList.add('text-bg-warning');
      } else {
        toastEl.classList.add('text-bg-success');
      }
      
      const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });
      toast.show();
    }

    async function deleteLead(leadId) {
      if (!confirm('Are you sure you want to delete this lead?')) return;
      
      try {
        const response = await fetch(`/admin/booking-leads/${leadId}`, {
          method: 'DELETE',
          headers: {
            'X-CSRF-Token': '<%= csrfToken %>',
          },
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('Success', 'Lead deleted successfully', 'success');
          setTimeout(() => window.location.reload(), 1500);
        } else {
          showToast('Error', result.message || 'Failed to delete lead', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showToast('Error', 'An error occurred', 'error');
      }
    }
  </script>
  
  <!-- Bootstrap JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
</body>
</html>

